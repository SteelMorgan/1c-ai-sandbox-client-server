services:
  agent:
    container_name: 1c-ai-sandbox
    hostname: 1c-ai-sandbox
    build:
      context: ..
      dockerfile: .devcontainer/Dockerfile
      args:
        # Must match the version required by the runner (exact 4-part version).
        ONEC_VERSION: ${ONEC_VERSION}
      secrets:
        - onec_username
        - onec_password
        - dev_login
        - dev_password
    environment:
      ONEC_VERSION: ${ONEC_VERSION}
      # Some 1C tools require an X server even in "batch" mode.
      # We run Xvfb on :99 in entrypoint to satisfy this requirement.
      DISPLAY: ":99"
      # Force UTF-8 locale inside the sandbox so Cyrillic file names are preserved.
      LANG: "ru_RU.UTF-8"
      LC_ALL: "ru_RU.UTF-8"
      LC_CTYPE: "ru_RU.UTF-8"
      LANGUAGE: "ru_RU:ru"
    env_file:
      - .env
      - ../infra/vm/.env
    # Runtime secrets (mounted into /run/secrets/*). Required for onec-activate-community.sh.
    secrets:
      - dev_login
      - dev_password
      - github_token
    volumes:
      # Separate workspace volume for 1C sandbox
      - agent-work-sandbox-1c:/workspaces/work
      # Persist licenses across rebuilds
      - onec-licenses:/var/1C/licenses
      # Persist GitHub CLI auth between container recreates/rebuilds.
      - gh-config-1c:/home/vscode/.config/gh
    extra_hosts:
      - "STEEL-PC:host-gateway"
      # 1C infra VM (mgmt IP) is synced dynamically from infra/vm/.env by .devcontainer/sync-onec-infra-hosts.sh
    networks:
      default: {}
      infra:
        ipv4_address: 192.168.0.10

secrets:
  # Build-time: download platform from releases.1c.ru (BuildKit secrets)
  onec_username:
    file: ../secrets/onec_username
  onec_password:
    file: ../secrets/onec_password
  # Runtime: community activation (read by activation script)
  dev_login:
    file: ../secrets/dev_login
  dev_password:
    file: ../secrets/dev_password
  # Runtime: GitHub CLI auth (PAT). Used by .devcontainer/gh-auth-bootstrap.sh
  github_token:
    file: ../secrets/github_token

volumes:
  agent-work-sandbox-1c:
    external: true
  onec-licenses:
  gh-config-1c:

networks:
  infra:
    external: true
    name: ${AGENT_INFRA_NETWORK:-infra}

