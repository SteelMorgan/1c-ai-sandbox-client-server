## Песочница для ИИ‑агента под 1С (клиент + серверная инфраструктура)

Этот репозиторий — песочница под ИИ‑агента и инфраструктура, где агент работает с платформой 1С.
**Зачем это нужно?** - Что бы ИИ-агент по ошибке вам что нито **не удалил (например, весь диск D... или C)**
**Думаете с Вами точно такого не случится? - Я тоже так думал.** А потом потерял 10 лет семейных фото и пошел делать песочницу :)


Всё разделено на две части:

- **Клиентская часть (Dev Container)**: Linux‑контейнер с установленной платформой 1С **для клиента** (толстый/тонкий клиент, в т.ч. Конфигуратор) + “обвязка”, чтобы инструменты 1С стабильно работали в headless‑режиме.
- **Серверная часть (VM в Hyper‑V)**: отдельная Ubuntu VM, внутри неё Docker Compose со связкой **1С сервер + Postgres**.

### Архитектура (схема)

```text
                        Windows host
┌───────────────────────────────────────────────────────────────────────────┐
│  Cursor / VS Code + Dev Containers                                        │
│  Docker Desktop                                                           │
│  Hyper‑V                                                                  │
└───────────────┬───────────────────────────────┬───────────────────────────┘
                │                               │
                │ Dev Container                 │ VM (Hyper‑V)
                v                               v
┌───────────────────────────────────┐   ┌──────────────────────────────────┐
│ Клиентская песочница (container)  │   │ Серверная часть (Ubuntu VM)      │
│                                   │   │                                  │
│  agent (Linux)                    │   │  docker + docker compose         │
│   - 1С клиент + Конфигуратор      │   │   - onec-server                  │
│   - Xvfb :99 (headless display)   │   │   - postgres                     │
│   - community-активация КЛИЕНТА   │   │                                  │
│     (если заданы DEV_* креды)     │   │  Порты наружу: 1540/1541/1545,   │
│                                   │   │  1560-1591, 5432                 │
│                                   │   └──────────────────────────────────┘
│  Volumes:                         │   
│   - workspace volume              │
│   - onec-licenses volume          │
│                                   │
│  Networking:                      │
│   - (опц.) docker network "infra" │
│   - /etc/hosts: onec-infra ->     │
│     management IP VM (если задан) │
└───────────────────────────────────┘

Связь: контейнер управляет/подключается к 1С‑серверу в VM по MGMT IP или имени onec-infra.
```

### Ограничения

- **Хост‑окружение, где проверено**: Windows (Hyper‑V + PowerShell) как хост для серверной части.
- **Linux‑хосты** (KVM/QEMU/VirtualBox, бриджи/iptables и т.п.) **не тестировались**.

## Быстрый старт

### 1) Серверная инфраструктура (Hyper‑V VM)

Сначала подними серверную часть — без неё клиентская песочница не сможет нормально подключаться к 1С‑серверу.

- Подготовь non‑secret конфиг VM:
  - скопируй `infra/vm/.env.example` → `infra/vm/.env`
  - в основном можно оставить параметры по-умолчанию; обрати внимание на FORCE_RECREATE_VM (принудительно Пересоздает виртуальную машину) и на размер диска виртуальной машины.
- Подготовь локальные секреты:
  - скопируй `secrets/.env.example` → `secrets/.env`
  - заполни нужные логин/пароли
- Запусти скрипт развёртки **из PowerShell от администратора**: `scripts/tests/SmokeTest-OnecInfra.ps1` и дождись успешного завершения (PASS).
- Для удобства работы с сервером 1С **с хост‑системы** рекомендуется добавить запись в `hosts`, чтобы VM резолвилась по имени:
  - `<MGMT_VM_IP> onec-infra` 
  - `MGMT_VM_IP` — management IP VM из `infra/vm/.env`
  - (прим.: `192.168.254.2 onec-infra`)

После успешной развёртки у тебя есть VM с Ubuntu + Docker и внутри неё подняты контейнеры 1С‑сервера и Postgres.

### Что делает скрипт развёртки (в общих чертах)

Серверный сценарий рассчитан на Windows‑хост и делает примерно так:

1. Берёт значения из `secrets/.env` и готовит Docker‑secrets файлы (без печати значений).
2. Скачивает **официальный Ubuntu Server ISO**, **патчит его под autoinstall** и использует уже пропатченный ISO для установки VM.
3. Создаёт VM в Hyper‑V, настраивает доступ по SSH и дожидается, пока VM станет доступна.
4. Загружает на VM нужные файлы и поднимает Docker Compose стек: **1С сервер + Postgres**.
5. Дожидается health‑состояния 1С‑сервера и делает базовые проверки (порты/кластер).

### Как запускать серверный сценарий

Запускать PowerShell **от администратора**. Скрипт развертки виртуальной машины тестировался под Power Shell 7 !!! (по умолчанию на винде вроде 5.1 стоит)

### 2) Клиентская песочница (Cursor/VS Code)

Требования:

- Docker Desktop запущен
- расширение **Dev Containers** (`ms-vscode-remote.remote-containers`)

Дальше так:

- Открываешь Cursor/VS Code
- Команда **Dev Containers: Open Folder in Container** и выбираешь папку **этого** репозитория
- Откроется **новое окно**, уже подключённое к клиентскому контейнеру
- Уже в **новом окне** делаешь **File → Open Folder…** и выбираешь рабочую папку конкретного проекта, с которым будет работать агент


## Что настроено

Клиентская песочница сделана так, чтобы 1С‑инструменты работали предсказуемо внутри контейнера:

- **Headless display**: поднимается Xvfb (некоторые режимы 1С требуют X‑сервера даже без UI).
- **Активация community‑лицензии клиента**: при старте контейнера выполняется авто‑активация **клиентской** community‑лицензии, *если* заданы креды `developer.1c.ru`.
- **Лицензии не теряются**: лицензии лежат в отдельном volume и переживают пересборку контейнера.
- **Маппинг имени VM внутрь контейнера**: при старте может обновляться `/etc/hosts`, чтобы имя `onec-infra` указывало на management‑IP VM (если этот IP задан в локальной конфигурации инфраструктуры).
- **Анти‑футган для git**: стоит pre‑push хук, блокирующий push прямо в `main/master` (чтобы случайно не убить публичный репо). В принципе не обязательно для 1С проектов, т.к. код регулярно бекапится "в базу" при запуске юнит-тестов (а для версионирования достаточно локального репо), но если нужно, то агенту выделяется отдельная ветка и хук запрещает пушить мейн ветку (только через PR)
- **CLI‑инструменты**: внутри есть базовые утилиты (git, gh, docker cli и т.п.), чтобы агент мог работать “из коробки”.

## Секреты: единый источник истины

**Источник истины — `secrets/.env` (локально, не коммитится).**  
Из него автоматически генерируются файлы `secrets/*`, которые уже используются как Docker secrets (`/run/secrets/*`).

## Версия платформы 1С: один источник истины

**Единый источник истины — `infra/vm/.env` (переменная `ONEC_VERSION`).**  
Серверная часть фиксируется на конкретной версии платформы, а клиентская песочница и прочие компоненты **подхватывают ту же версию**.

Что обычно лежит в `secrets/.env`:

- **releases.1c.ru** (`ONEC_USERNAME`, `ONEC_PASSWORD`) — нужно **только если** сборка должна скачать дистрибутив платформы (когда локального установщика нет).
- **developer.1c.ru** (`DEV_LOGIN`, `DEV_PASSWORD`) — включает авто‑активацию community‑лицензии (и в клиентской песочнице, и на сервере, если ты это включаешь).
- **Postgres** (`PG_PASSWORD`) — опционально. Если не задан, пароль генерируется один раз и сохраняется, чтобы деплой был воспроизводимым.


## Шаблоны репозиториев

В `templates/` лежат “seed”‑шаблоны, чтобы быстро стартовать новый репозиторий под проект/агента на базе этой песочницы.


## Улучшения
- криво работает очистка папки кеш. не всегда удаляет старые образы после создания нового (или вообще не удаляет?)
- протестить сборку на линукс окружении (не тестировалось, разрабатывалось под windows)
